@model IEnumerable<MyMvcApp.Models.Student>

@{
    ViewData["Title"] = "Students";
    var currentSort = ViewData["CurrentSort"] as string;
    var rollSortParam = ViewData["RollSortParam"] as string ?? "roll_asc";
    var currentFilter = ViewData["CurrentFilter"] as string ?? string.Empty;

    var classes = ViewBag.Classes as List<MyMvcApp.Models.Classroom> ?? new List<MyMvcApp.Models.Classroom>();
    var sectionCounts = ViewBag.SectionCounts as Dictionary<int, int> ?? new Dictionary<int, int>();
}

<h2 class="mb-3">Students</h2>

<form method="get" class="mb-3 d-flex gap-2 flex-wrap">
    <input type="text" name="search" placeholder="Search by name / email / roll" value="@currentFilter" class="form-control" style="min-width:160px;max-width:300px" />
    <button class="btn btn-primary">Search</button>
    <a asp-action="Create" class="btn btn-success ms-2">Add Student</a>

    <!-- small-screen: toggle sidebar -->
    <button class="btn btn-outline-secondary ms-auto d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#studentsSidebar" aria-expanded="false" aria-controls="studentsSidebar">
        Classes ▾
    </button>
</form>

@* Wrapper with independent-scroll behavior *@
<div class="students-wrapper">
    <!-- SIDEBAR -->
    <aside id="studentsSidebar" class="students-sidebar collapse d-md-block">
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">Classes</h6>
                <ul class="list-group list-group-flush">
                    @foreach (var c in classes)
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <a class="fw-semibold" asp-controller="Students" asp-action="ByClass" asp-route-id="@c.Id">@c.Name</a>
                                <a class="btn btn-sm btn-outline-secondary" asp-controller="Students" asp-action="ByClass" asp-route-id="@c.Id">View</a>
                            </div>

                            <div class="mt-2 d-flex flex-wrap">
                                @{
                                    var secs = (c.Sections != null && c.Sections.Any()) ? c.Sections.OrderBy(s => s.Name).ToList() : new List<MyMvcApp.Models.Section>();
                                }

                                @if (secs.Count > 0)
                                {
                                    foreach (var s in secs)
                                    {
                                        var cnt = sectionCounts.ContainsKey(s.Id) ? sectionCounts[s.Id] : 0;
                                        <a class="btn btn-sm btn-light me-1 mb-1"
                                           style="font-size:0.85rem"
                                           asp-controller="Students"
                                           asp-action="ByClass"
                                           asp-route-id="@c.Id"
                                           asp-route-sectionId="@s.Id">
                                            @s.Name (@cnt)
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No sections</span>
                                }
                            </div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="students-main">
        <div class="table-responsive students-table-container">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th style="width:80px">Photo</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Class</th>
                        <th>Section</th>
                        <th>
                            <a asp-action="Index" asp-route-search="@currentFilter" asp-route-sortOrder="@rollSortParam">
                                Roll
                                @if (currentSort == "roll_asc")
                                {
                                    <span>&nbsp;▲</span>
                                }
                                else if (currentSort == "roll_desc")
                                {
                                    <span>&nbsp;▼</span>
                                }
                            </a>
                        </th>
                        <th>Status</th>
                        <th style="min-width:220px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null)
                    {
                        foreach (var s in Model)
                        {
                            <tr>
                                <td>
                                    @if (!string.IsNullOrEmpty(s.PhotoPath))
                                    {
                                        <img src="@s.PhotoPath" class="student-thumb" alt="photo" />
                                    }
                                    else
                                    {
                                        <img src="~/images/default-user.png" class="student-thumb" alt="photo" />
                                    }
                                </td>
                                <td class="text-nowrap">@s.Name</td>
                                <td class="text-truncate" style="max-width:180px">@s.Email</td>
                                <td>@s.Classroom?.Name</td>
                                <td>@s.Section?.Name</td>
                                <td>@s.Roll</td>
                                <td>
                                    @if (s.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        <a asp-action="Details" asp-route-id="@s.Id" class="btn btn-sm btn-info">Profile</a>
                                        <a asp-action="Edit" asp-route-id="@s.Id" class="btn btn-sm btn-warning">Edit</a>
                                        <a asp-action="Delete" asp-route-id="@s.Id" class="btn btn-sm btn-danger">Delete</a>

                                        <form asp-action="ToggleStatus" asp-route-id="@s.Id" method="post" style="display:inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="returnUrl" value="@(Context.Request.Path + Context.Request.QueryString)" />
                                            @if (s.IsActive)
                                            {
                                                <button type="submit" class="btn btn-sm btn-secondary">Deactivate</button>
                                            }
                                            else
                                            {
                                                <button type="submit" class="btn btn-sm btn-success">Activate</button>
                                            }
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            @* pagination placeholder *@
        </div>
    </main>
</div>
